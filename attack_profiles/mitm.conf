#!/bin/bash
#####################################################################
# MAN-IN-THE-MIDDLE (MITM) ATTACK PROFILE
# 
# Purpose: Intercept and potentially modify traffic between UE and core
# Method: False BS acts as relay with packet inspection/modification
#
# WARNING: For RESEARCH and EDUCATIONAL purposes ONLY
#####################################################################

# Profile name
ATTACK_NAME="Man-in-the-Middle"
ATTACK_TYPE="mitm"

#####################################################################
# MITM ARCHITECTURE
#####################################################################
# How the MITM operates
MITM_MODE="passive"  # Options: passive (capture only), active (modify)

# Relay to actual core network
RELAY_TO_REAL_CORE=true
REAL_CORE_MME_IP="127.0.1.2"
REAL_CORE_AMF_IP="127.0.0.5"

# Or create fake responses
FAKE_CORE_RESPONSES=false

#####################################################################
# TRAFFIC INTERCEPTION
#####################################################################
# What to intercept
INTERCEPT_NAS_MESSAGES=true
INTERCEPT_USER_PLANE=true
INTERCEPT_CONTROL_PLANE=true

# Capture settings
CAPTURE_ALL_TRAFFIC=true
CAPTURE_PCAP="/tmp/mitm_full_capture.pcap"
CAPTURE_NAS_ONLY="/tmp/mitm_nas_capture.pcap"
CAPTURE_USER_PLANE="/tmp/mitm_user_plane.pcap"

#####################################################################
# PACKET INSPECTION
#####################################################################
# Deep packet inspection
DPI_ENABLED=true
DPI_LOG="/tmp/mitm_dpi.log"

# What to inspect
INSPECT_HTTP=true
INSPECT_HTTPS=false  # Can't decrypt without cert
INSPECT_DNS=true
INSPECT_ICMP=true

# Extract data
EXTRACT_URLS=true
EXTRACT_HOSTNAMES=true
EXTRACT_USER_AGENTS=true

#####################################################################
# PACKET MODIFICATION (Active MITM)
#####################################################################
# Enable only if MITM_MODE="active"
MODIFY_PACKETS=false

# Modification rules
MODIFY_DNS_RESPONSES=false
MODIFY_HTTP_RESPONSES=false
INJECT_JAVASCRIPT=false
REDIRECT_TRAFFIC=false

# Redirect rules
REDIRECT_TARGET_IP=""
REDIRECT_TARGET_PORT=""

#####################################################################
# TRAFFIC FORWARDING
#####################################################################
# Forward traffic to real core
FORWARD_TO_CORE=true
FORWARD_DELAY_MS=0  # Add latency to detect

# GTP tunnel settings
GTP_TUNNEL_ENABLED=true
GTP_LOG="/tmp/mitm_gtp.log"

#####################################################################
# S1AP/NGAP MANIPULATION
#####################################################################
# Intercept S1AP (4G) or NGAP (5G) messages
S1AP_INTERCEPTION=true
NGAP_INTERCEPTION=true

# Log specific messages
LOG_ATTACH_REQUEST=true
LOG_AUTHENTICATION=true
LOG_SECURITY_MODE=true
LOG_PDN_CONNECTIVITY=true
LOG_PDU_SESSION=true

#####################################################################
# SECURITY HANDLING
#####################################################################
# To perform MITM, we need to handle encryption
# Options: disable (EEA0), relay encrypted, or break (requires keys)

SECURITY_MODE="relay_encrypted"  # relay encrypted traffic as-is
# SECURITY_MODE="disable"  # Force EEA0 for plaintext
# SECURITY_MODE="break"  # Attempt to break/obtain keys

#####################################################################
# USER PLANE ANALYSIS
#####################################################################
# Analyze user plane traffic
ANALYZE_USER_TRAFFIC=true

# Traffic statistics
TRACK_BANDWIDTH=true
TRACK_DESTINATIONS=true
TRACK_PROTOCOLS=true

STATS_FILE="/tmp/mitm_traffic_stats.json"

#####################################################################
# LOGGING & ALERTING
#####################################################################
LOG_LEVEL="debug"
LOG_FILE="/tmp/mitm_attack.log"

# Alert on interesting events
ALERT_ON_HTTP=true
ALERT_ON_AUTHENTICATION=true
ALERT_ON_NEW_BEARER=true

#####################################################################
# DESCRIPTION
#####################################################################
ATTACK_DESCRIPTION="Man-in-the-Middle attack intercepts traffic between UE and core network. False BS can capture, inspect, and potentially modify data."

ATTACK_HOWTO="1. Configure relay to real core network
2. Start false BS with this profile
3. UE connects to false BS (higher signal)
4. All traffic flows through false BS
5. Traffic is logged and analyzed
6. Optionally forward to real core for transparent operation
7. Review captured PCAPs and logs"

ATTACK_COUNTERMEASURES="- Use end-to-end encryption (HTTPS, VPN)
- Implement certificate pinning
- Monitor for suspicious network behavior
- Verify base station authenticity
- Use strong NAS encryption (EEA2/NEA2)
- Detect unusual latency or packet patterns"

#####################################################################
# PCAP SETTINGS
#####################################################################
PCAP_ENABLED=true
PCAP_ROTATION_SIZE_MB=100
PCAP_MAX_FILES=10
PCAP_DIRECTORY="/tmp/mitm_pcaps"


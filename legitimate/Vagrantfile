# -*- mode: ruby -*-
# vi: set ft=ruby :

#####################################################################
# LEGITIMATE BASE STATION - Vagrant Configuration
#
# VM for legitimate cellular network base station
# Components: Open5GS + srsRAN 4G + 2x LibreSDR B220 mini
#
# Network: 192.168.56.10
# SDR Devices: LibreSDR B220 #1 + #2 (USB passthrough required)
#####################################################################

Vagrant.configure("2") do |config|
  # Base box - Ubuntu 22.04 LTS (Jammy Jellyfish)
  config.vm.box = "ubuntu/jammy64"
  config.vm.hostname = "legitimate-bs"

  # Network configuration - BRIDGED MODE
  # VM will get IP from your host network's DHCP server
  # Accessible from any device on your local network
  config.vm.network "public_network", bridge: "enp4s0"

  # Note: Port forwarding removed since VM is now directly on your network
  # Access WebUI directly at: http://<VM_IP>:9999

  # VM resources
  config.vm.provider "virtualbox" do |vb|
    vb.name = "legitimate-base-station"
    vb.memory = "6144"  # 6GB RAM for UHD compilation
    vb.cpus = 4
    
    # USB 3.0 only (xHCI) - disable OHCI/EHCI to prevent conflicts
    vb.customize ["modifyvm", :id, "--usbohci", "off"]
    vb.customize ["modifyvm", :id, "--usbehci", "off"]
    vb.customize ["modifyvm", :id, "--usbxhci", "on"]
    
    # USB passthrough for 2x LibreSDR B220 - LEGITIMATE BS
    # ‚ö†Ô∏è  IMPORTANT: This VM requires TWO physical SDR devices
    # Multiple VMs cannot share the same USB SDR device

    # AUTOMATIC USB FILTER DISABLED to prevent conflicts between VMs
    # Manual USB assignment required via VirtualBox GUI or sdr_manager.sh

    puts "=" * 60
    puts "üîå SDR DEVICE CONFIGURATION - LEGITIMATE BS (2 DEVICES)"
    puts "=" * 60
    puts "REQUIRED: Connect BOTH SDR Devices #1 and #2 to this VM"
    puts ""
    puts "üìã Device Requirements:"
    puts "  ‚Ä¢ Hardware: USRP B210 or LibreSDR B220"
    puts "  ‚Ä¢ VendorID: 0x2500, ProductID: 0x0020"
    puts "  ‚Ä¢ SDR #1 Serial: C5XA7X9"
    puts "  ‚Ä¢ SDR #2 Serial: P44SEGH"
    puts ""
    puts "üìã Manual USB Assignment Steps:"
    puts "  1. Start this VM: vagrant up"
    puts "  2. Connect both SDRs to host USB ports"
    puts "  3. In VirtualBox GUI: VM Menu ‚Üí Devices ‚Üí USB"
    puts "  4. Select: 'Ettus Research LLC USRP B210' (SDR #1 - C5XA7X9)"
    puts "  5. Select: 'Ettus Research LLC USRP B210' (SDR #2 - P44SEGH)"
    puts "  6. Verify: vagrant ssh ‚Üí uhd_find_devices"
    puts ""
    puts "üìã Alternative - Use SDR Manager:"
    puts "  ./sdr_manager.sh attach legitimate  # Auto-attach both SDRs"
    puts ""
    puts "‚ö†Ô∏è  CONFLICT PREVENTION:"
    puts "  ‚Ä¢ SDR #1 (C5XA7X9) + SDR #2 (P44SEGH) = legitimate VM"
    puts "  ‚Ä¢ SDR #3 (VRFKZRP) = false VM"
    puts "  ‚Ä¢ SDR #1 (C5XA7X9) also used by legitimate_5g VM"
    puts "  ‚Ä¢ Never connect the same SDR to multiple running VMs"
    puts "=" * 60
  end

  # Shared folders
  config.vm.synced_folder ".", "/vagrant", type: "virtualbox"
  config.vm.synced_folder "../shared", "/vagrant/shared", create: true
  config.vm.synced_folder "./configs", "/vagrant/configs", create: true
  config.vm.synced_folder "./scripts", "/vagrant/scripts", create: true
  config.vm.synced_folder "./install", "/vagrant/install", create: true

  # Provisioning
  config.vm.provision "shell", path: "provision.sh", run: "always"

  # Post-provisioning message
  config.vm.post_up_message = <<-MSG
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë                                                            ‚ïë
    ‚ïë        Legitimate Base Station VM Ready!                   ‚ïë
    ‚ïë                                                            ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    Access the VM:
      vagrant ssh

    Network Configuration:
      Mode: BRIDGED - VM gets IP from your network DHCP
      Find VM IP: vagrant ssh && ip addr show | grep "inet "

    Default Test Subscriber (Pre-configured):
      IMSI: 001010000118896
      Ki:   BD9044E60EFA8AD9052799E65D8AF224
      OPc:  C86FD5618B748B85BBC6515C7AEDB9A4

    Subscriber Management:
      sudo subscriber.sh list              # List all subscribers
      sudo subscriber.sh count             # Count subscribers
      sudo subscriber.sh add <imsi> <k> <opc>  # Add new subscriber

    Quick Start:
      1. Attach SDR devices: ./sdr_manager.sh attach legitimate
      2. SSH into VM: vagrant ssh
      3. Verify SDRs: uhd_find_devices (should show 2 devices)
      4. Verify subscriber: sudo subscriber.sh list
      5. Optional - Enable cross-VM access: sudo /vagrant/shared/utils/configure_mme_network.sh
      6. Start 4G LTE BS #1: sudo srsenb /etc/srsran/legitimate/enb_4g.conf
      7. Start 4G LTE BS #2: sudo srsenb /etc/srsran/legitimate2/enb_4g.conf

    Monitoring:
      sudo monitor_handover.sh     # Monitor UE handovers

    Important:
      - This VM uses 2 SDR devices (C5XA7X9 + P44SEGH)
      - Always start this VM FIRST before false BS
      - Default test subscriber is pre-configured
      - Use subscriber.sh to add more test UEs
      - Two separate base stations can run simultaneously
  MSG
end

